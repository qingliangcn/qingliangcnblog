<!--
author: qingliangcn
date: 2009-07-04
title: PHP中memcache扩展set失败的解决
tags: failed,memcache,memcached,php,失败
category: PHP高级应用
status: publish
summary: 在代码中遇到了memcache set方法失败的问题，无任何错误提示，PHP的memcache扩展本身也没有debug或者error提示。同样的代码，将本地的环境跟服务器的环境对比了一下（在服务器端一直没有遇到这个问题），发现原来是我所使用的php memcache扩展版本较低导
-->

<p>在代码中遇到了memcache set方法失败的问题，无任何错误提示，PHP的memcache扩展本身也没有debug或者error提示。同样的代码，将本地的环境跟服务器的环境对比了一下（在服务器端一直没有遇到这个问题），发现原来是我所使用的php memcache扩展版本较低导致的。PECL有个bug报告http://pecl.php.net/bugs/bug.php?id=9486 ，也是提到这个问题了，在新的版本中已经解决了（2.1.1）。<br />
<br />
使用php的memcache扩展时，如果给set/get方法传递一个空值（NULL），则会导致memcached服务端主动关闭连接，见如下的代码示范：<br />
&nbsp;</p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(102,0,0); font-size: 10pt; mso-spacerun: 'yes'">$mem&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10pt; mso-spacerun: 'yes'">=&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(0,0,255); font-size: 10pt; mso-spacerun: 'yes'">new&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10pt; mso-spacerun: 'yes'">Memcache();</span><span style="font-family: 'Courier New'; font-size: 10pt; mso-spacerun: 'yes'"><o:p></o:p></span></p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(102,0,0); font-size: 10pt; mso-spacerun: 'yes'">$mem</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10pt; mso-spacerun: 'yes'">-&gt;connect(</span><span style="font-family: 'Courier New'; color: rgb(0,130,0); font-size: 10pt; mso-spacerun: 'yes'">'192.168.64.12'</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10pt; mso-spacerun: 'yes'">,&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(0,130,0); font-size: 10pt; mso-spacerun: 'yes'">'11211'</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10pt; mso-spacerun: 'yes'">);</span><span style="font-family: 'Courier New'; font-size: 10pt; mso-spacerun: 'yes'"><o:p></o:p></span></p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(102,0,0); font-size: 10pt; mso-spacerun: 'yes'">$mem</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10pt; mso-spacerun: 'yes'">-&gt;set(</span><span style="font-family: 'Courier New'; color: rgb(0,130,0); font-size: 10pt; mso-spacerun: 'yes'">'aaa'</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10pt; mso-spacerun: 'yes'">,&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(0,0,255); font-size: 10pt; mso-spacerun: 'yes'">array</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10pt; mso-spacerun: 'yes'">(</span><span style="font-family: 'Courier New'; color: rgb(0,130,0); font-size: 10pt; mso-spacerun: 'yes'">'aaa'</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10pt; mso-spacerun: 'yes'">));&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(128,128,128); font-size: 10pt; mso-spacerun: 'yes'">//成功</span><span style="font-family: 'Courier New'; font-size: 10pt; mso-spacerun: 'yes'"><o:p></o:p></span></p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(102,0,0); font-size: 10pt; text-decoration: underline; mso-spacerun: 'yes'">$mem</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10pt; text-decoration: underline; mso-spacerun: 'yes'">-&gt;set(</span><span style="font-family: 'Courier New'; color: rgb(102,0,0); font-size: 10pt; text-decoration: underline; mso-spacerun: 'yes'">$aaaa</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10pt; text-decoration: underline; mso-spacerun: 'yes'">,&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(0,130,0); font-size: 10pt; text-decoration: underline; mso-spacerun: 'yes'">'aaaa'</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10pt; text-decoration: underline; mso-spacerun: 'yes'">);&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(128,128,128); font-size: 10pt; text-decoration: underline; mso-spacerun: 'yes'">//失败，并导致到memcached服务器的连接丢失，所以之后的方法都失败了（返回false）</span><span style="font-family: 'Courier New'; font-size: 10pt; mso-spacerun: 'yes'"><o:p></o:p></span></p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(102,0,0); font-size: 10pt; mso-spacerun: 'yes'">$mem</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10pt; mso-spacerun: 'yes'">-&gt;set(</span><span style="font-family: 'Courier New'; color: rgb(0,130,0); font-size: 10pt; mso-spacerun: 'yes'">'bbb'</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10pt; mso-spacerun: 'yes'">,&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(0,0,255); font-size: 10pt; mso-spacerun: 'yes'">array</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10pt; mso-spacerun: 'yes'">(</span><span style="font-family: 'Courier New'; color: rgb(0,130,0); font-size: 10pt; mso-spacerun: 'yes'">'bbb'</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10pt; mso-spacerun: 'yes'">));</span><span style="font-family: 'Courier New'; color: rgb(128,128,128); font-size: 10pt; mso-spacerun: 'yes'">//失败</span><span style="font-family: 'Courier New'; font-size: 10pt; mso-spacerun: 'yes'"><o:p></o:p></span></p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(102,0,0); font-size: 10pt; mso-spacerun: 'yes'">$mem</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10pt; mso-spacerun: 'yes'">-&gt;get(</span><span style="font-family: 'Courier New'; color: rgb(0,130,0); font-size: 10pt; mso-spacerun: 'yes'">'aaa'</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10pt; mso-spacerun: 'yes'">);</span><span style="font-family: 'Courier New'; color: rgb(128,128,128); font-size: 10pt; mso-spacerun: 'yes'">//失败</span><!--EndFragment--><br />
<br />
没有测试memcached扩展是否有过这样的bug。<br />
顺便提一下在PHP中memcached和memcache是两个不同的扩展，区别是memcached基于libmemcached库封装的API接口。见PHP手册<br />
This extension uses libmemcached library to provide API for communicating with memcached servers. It also provides a session handler (memcached).<br />
<br />
而通常所说的memcached就是指memcached服务器端。<br />
<br />
另外如果key过长（250以上），value过大（1M以上）或者过期时间过长（大于2592000）都会导致set失败。</p>