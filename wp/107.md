<!--
author: admin
date: 2009-02-20
title: Zend Framework代码实例 -- 手工扑捉PHP内部错误
tags: 
category: PHP基础应用,暂未分类
status: publish
summary: 很明显本文的标题不够准确、不能很好体现本文所要表达的意思, 如果你想明白我想说什么, 那么你只好看下去. 呵呵.今天看ZF源码时看到类Zend_Config_Ini中一段比较有意思的代码:set_error_handler(array($this,&nbsp;'_loadFile
-->

<p>很明显本文的标题不够准确、不能很好体现本文所要表达的意思, 如果你想明白我想说什么, 那么你只好看下去. 呵呵.<br />
今天看ZF源码时看到类Zend_Config_Ini中一段比较有意思的代码:</p>
<p><span>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">set_error_handler(</span><span style="font-family: 'Courier New'; color: rgb(0,0,255); font-size: 10.5pt; mso-spacerun: 'yes'">array</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">(</span><span style="font-family: 'Courier New'; color: rgb(102,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">$this</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">,&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(0,130,0); font-size: 10.5pt; mso-spacerun: 'yes'">'_loadFileErrorHandler'</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">));&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-family: 'Courier New'; font-size: 10.5pt; mso-spacerun: 'yes'"><o:p></o:p></span></p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(102,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">$iniArray&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">=&nbsp;parse_ini_file(</span><span style="font-family: 'Courier New'; color: rgb(102,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">$filename</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">,&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(0,0,255); font-size: 10.5pt; mso-spacerun: 'yes'">true</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">);&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(128,128,128); font-size: 10.5pt; mso-spacerun: 'yes'">//&nbsp;Warnings&nbsp;and&nbsp;errors&nbsp;are&nbsp;suppressed&nbsp;&nbsp;&nbsp;</span><span style="font-family: 'Courier New'; font-size: 10.5pt; mso-spacerun: 'yes'"><o:p></o:p></span></p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">restore_error_handler();&nbsp;&nbsp;&nbsp;</span><span style="font-family: 'Courier New'; font-size: 10.5pt; mso-spacerun: 'yes'"><o:p></o:p></span></p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(128,128,128); font-size: 10.5pt; mso-spacerun: 'yes'">//&nbsp;Check&nbsp;if&nbsp;there&nbsp;was&nbsp;a&nbsp;error&nbsp;while&nbsp;loading&nbsp;file&nbsp;&nbsp;&nbsp;</span><span style="font-family: 'Courier New'; font-size: 10.5pt; mso-spacerun: 'yes'"><o:p></o:p></span></p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(0,0,255); font-size: 10.5pt; mso-spacerun: 'yes'">if&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">(</span><span style="font-family: 'Courier New'; color: rgb(102,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">$this</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">-&gt;_loadFileErrorStr&nbsp;!==&nbsp;null)&nbsp;{&nbsp;&nbsp;&nbsp;</span><span style="font-family: 'Courier New'; font-size: 10.5pt; mso-spacerun: 'yes'"><o:p></o:p></span></p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(128,128,128); font-size: 10.5pt; mso-spacerun: 'yes'">/**&nbsp;&nbsp;</span><span style="font-family: 'Courier New'; font-size: 10.5pt; mso-spacerun: 'yes'"><o:p></o:p></span></p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(128,128,128); font-size: 10.5pt; mso-spacerun: 'yes'">*&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(128,128,128); font-size: 10.5pt; font-weight: bold; mso-spacerun: 'yes'">@see</span><span style="font-family: 'Courier New'; color: rgb(128,128,128); font-size: 10.5pt; mso-spacerun: 'yes'">&nbsp;Zend_Config_Exception&nbsp;&nbsp;</span><span style="font-family: 'Courier New'; font-size: 10.5pt; mso-spacerun: 'yes'"><o:p></o:p></span></p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(128,128,128); font-size: 10.5pt; mso-spacerun: 'yes'">*/</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">&nbsp;&nbsp;</span><span style="font-family: 'Courier New'; font-size: 10.5pt; mso-spacerun: 'yes'"><o:p></o:p></span></p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(0,0,255); font-size: 10.5pt; text-decoration: underline; mso-spacerun: 'yes'">require_once&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(0,130,0); font-size: 10.5pt; text-decoration: underline; mso-spacerun: 'yes'">'Zend/Config/Exception.php'</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; text-decoration: underline; mso-spacerun: 'yes'">;</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">&nbsp;&nbsp;&nbsp;</span><span style="font-family: 'Courier New'; font-size: 10.5pt; mso-spacerun: 'yes'"><o:p></o:p></span></p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(0,0,255); font-size: 10.5pt; mso-spacerun: 'yes'">throw&nbsp;new&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">Zend_Config_Exception(</span><span style="font-family: 'Courier New'; color: rgb(102,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">$this</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">-&gt;_loadFileErrorStr);&nbsp;&nbsp;&nbsp;</span><span style="font-family: 'Courier New'; font-size: 10.5pt; mso-spacerun: 'yes'"><o:p></o:p></span></p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">}&nbsp;&nbsp;&nbsp;</span></p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt">&nbsp;</p>
<span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt">看了这段代码我的第一反应时为什么要这样处理呢?立刻转到错误处理方法看看<br />
&nbsp;</p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(0,0,255); font-size: 10.5pt; mso-spacerun: 'yes'">protected</span><span style="font-family: 'Courier New'; color: rgb(0,0,255); font-size: 10.5pt; mso-spacerun: 'yes'">&nbsp;function&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">_loadFileErrorHandler(</span><span style="font-family: 'Courier New'; color: rgb(102,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">$errno</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">,&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(102,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">$errstr</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">,&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(102,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">$errfile</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">,&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(102,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">$errline</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">)&nbsp;&nbsp;&nbsp;</span><span style="font-family: 'Courier New'; font-size: 10.5pt; mso-spacerun: 'yes'"><o:p></o:p></span></p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">{&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-family: 'Courier New'; font-size: 10.5pt; mso-spacerun: 'yes'"><o:p></o:p></span></p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(0,0,255); font-size: 10.5pt; mso-spacerun: 'yes'">if&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">(</span><span style="font-family: 'Courier New'; color: rgb(102,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">$this</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">-&gt;_loadFileErrorStr&nbsp;===&nbsp;null)&nbsp;{&nbsp;&nbsp;&nbsp;</span><span style="font-family: 'Courier New'; font-size: 10.5pt; mso-spacerun: 'yes'"><o:p></o:p></span></p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(102,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">$this</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">-&gt;_loadFileErrorStr&nbsp;=&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(102,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">$errstr</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">;&nbsp;&nbsp;&nbsp;</span><span style="font-family: 'Courier New'; font-size: 10.5pt; mso-spacerun: 'yes'"><o:p></o:p></span></p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(0,0,255); font-size: 10.5pt; mso-spacerun: 'yes'">else&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">{&nbsp;&nbsp;&nbsp;</span><span style="font-family: 'Courier New'; font-size: 10.5pt; mso-spacerun: 'yes'"><o:p></o:p></span></p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(102,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">$this</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">-&gt;_loadFileErrorStr&nbsp;.=&nbsp;(PHP_EOL&nbsp;.&nbsp;</span><span style="font-family: 'Courier New'; color: rgb(102,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">$errstr</span><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">);&nbsp;&nbsp;&nbsp;</span><span style="font-family: 'Courier New'; font-size: 10.5pt; mso-spacerun: 'yes'"><o:p></o:p></span></p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;</span><span style="font-family: 'Courier New'; font-size: 10.5pt; mso-spacerun: 'yes'"><o:p></o:p></span></p>
<p class="p0" style="margin-top: 0pt; margin-bottom: 0pt"><span style="font-family: 'Courier New'; color: rgb(0,0,0); font-size: 10.5pt; mso-spacerun: 'yes'">}</span></p>
<!--EndFragment--></span><!--EndFragment--></span></p>
<p>很简单,错误处理方法只是在出错时将类的$_loadFileErrorStr 属性设置为出错字符串.<br />
<br />
翻看PHP手册, 从parse_ini_file函数的定义我们可以看出该函数在出现错误时(例如文件不存在,ini文件格式不正确等等)直接输出错误信息, 而不是通过返回值来表达出错信息, 这样我们在使用该函数时就无法很好的控制------在出错时合适的终止程序并给出错误提示或者不可避免的将可能不可理解的错误信息呈现给用户, 为了能够比较简单的手工处理出错信息, 这里采用了这个修改出错处理函数的方法, 由于这个出错函数比较有局限性, 所以之后又立即恢复了出错处理函数.<br />
&nbsp;</p>