<!--
author: admin
date: 2010-08-11
title: erlang zlib引起的系统崩溃记录
tags: Erlang,erlang zlib
category: Erlang
status: publish
summary: author: 庆亮 (qing.liang.cn@gmail.com /&nbsp; http://twitter.com/qingliangcn ) date: 2010-07-12&nbsp;之前同事遇到一个问题，系统运行一段时间后有大量的port没有正常关闭而导致beam
-->

<p class="MsoNormal" style="margin: 0cm 0cm 0pt"><font color="#000000"><span lang="EN-US" style="font-size: 9pt"><font face="Calibri">author: </font></span><span style="font-family: 宋体; font-size: 9pt; mso-ascii-font-family: calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: calibri; mso-hansi-theme-font: minor-latin">庆亮</span></font><span lang="EN-US" style="font-size: 9pt"><font color="#000000" face="Calibri"> (</font><a href="mailto:qing.liang.cn@gmail.com"><font face="Calibri">qing.liang.cn@gmail.com</font></a><font color="#000000"><font face="Calibri"> /<span style="mso-spacerun: yes">&nbsp; </span></font></font><a href="http://twitter.com/qingliangcn"><font face="Calibri">http://twitter.com/qingliangcn</font></a><font face="Calibri"><font color="#000000"> ) <o:p></o:p></font></font></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt"><span lang="EN-US" style="font-size: 9pt"><font face="Calibri"><font color="#000000">date: 2010-07-12<o:p></o:p></font></font></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt"><span lang="EN-US" style="font-size: 9pt"><o:p><font color="#000000" face="Calibri">&nbsp;</font></o:p></span></p>
<p class="MsoNormal" style="text-indent: 21pt; margin: 0cm 0cm 0pt"><font color="#000000"><span style="font-family: 宋体; font-size: 9pt; mso-ascii-font-family: calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: calibri; mso-hansi-theme-font: minor-latin">之前同事遇到一个问题，系统运行一段时间后有大量的</span><span lang="EN-US" style="font-size: 9pt"><font face="Calibri">port</font></span><span style="font-family: 宋体; font-size: 9pt; mso-ascii-font-family: calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: calibri; mso-hansi-theme-font: minor-latin">没有正常关闭而导致</span><span lang="EN-US" style="font-size: 9pt"><font face="Calibri">beam</font></span><span style="font-family: 宋体; font-size: 9pt; mso-ascii-font-family: calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: calibri; mso-hansi-theme-font: minor-latin">崩溃，经过定位发现是由于</span><span lang="EN-US" style="font-size: 9pt"><font face="Calibri">zlib</font></span><span style="font-family: 宋体; font-size: 9pt; mso-ascii-font-family: calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: calibri; mso-hansi-theme-font: minor-latin">引起的。过程很简单，没什么技术含量，记录一下。<!--more--></span><span lang="EN-US" style="font-size: 9pt"><o:p></o:p></span></font></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt"><font color="#000000"><span style="font-family: 宋体; font-size: 9pt; mso-ascii-font-family: calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: calibri; mso-hansi-theme-font: minor-latin">错误信息大致是这样的（原因是传入的数据不是</span><span lang="EN-US" style="font-size: 9pt"><font face="Calibri">zlib</font></span><span style="font-family: 宋体; font-size: 9pt; mso-ascii-font-family: calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: calibri; mso-hansi-theme-font: minor-latin">压缩格式）：</span><span lang="EN-US" style="font-size: 9pt"><o:p></o:p></span></font></p>
<blockquote>
	<p class="MsoNormal" style="margin: 0cm 0cm 0pt"><span lang="EN-US" style="font-size: 9pt"><font face="Calibri"><font color="#000000">** exception error: data_error<o:p></o:p></font></font></span></p>
	<p class="MsoNormal" style="margin: 0cm 0cm 0pt"><span lang="EN-US" style="font-size: 9pt"><font face="Calibri"><font color="#000000"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>in function<span style="mso-spacerun: yes">&nbsp; </span>zlib:call/3<o:p></o:p></font></font></span></p>
	<p class="MsoNormal" style="margin: 0cm 0cm 0pt"><span lang="EN-US" style="font-size: 9pt"><font face="Calibri"><font color="#000000"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>in call from zlib:inflate/2<o:p></o:p></font></font></span></p>
	<p class="MsoNormal" style="margin: 0cm 0cm 0pt"><span lang="EN-US" style="font-size: 9pt"><font face="Calibri"><font color="#000000"><span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>in call from zlib:uncompress/1<o:p></o:p></font></font></span></p>
</blockquote>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt"><font color="#000000"><span style="font-family: 宋体; font-size: 9pt; mso-ascii-font-family: calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: calibri; mso-hansi-theme-font: minor-latin">看</span><span lang="EN-US" style="font-size: 9pt"><font face="Calibri">call</font></span><span style="font-family: 宋体; font-size: 9pt; mso-ascii-font-family: calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: calibri; mso-hansi-theme-font: minor-latin">的实现，应该是这里，</span><span lang="EN-US" style="font-size: 9pt"><font face="Calibri">erlang:error(list_to_atom(Res))</font></span><span style="font-family: 宋体; font-size: 9pt; mso-ascii-font-family: calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: calibri; mso-hansi-theme-font: minor-latin">，</span><span style="font-size: 9pt"><font face="Calibri"> <span lang="EN-US"><o:p></o:p></span></font></span></font></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt"><span lang="EN-US" style="font-size: 9pt"><o:p><font color="#000000" face="Calibri">&nbsp;</font></o:p></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt"><font color="#000000"><span style="font-family: 宋体; font-size: 9pt; mso-ascii-font-family: calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: calibri; mso-hansi-theme-font: minor-latin">看了下</span><span lang="EN-US" style="font-size: 9pt"><font face="Calibri">zlib</font></span><span style="font-family: 宋体; font-size: 9pt; mso-ascii-font-family: calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: calibri; mso-hansi-theme-font: minor-latin">的解压源码：</span><span lang="EN-US" style="font-size: 9pt"><o:p></o:p></span></font></p>
<blockquote>
	<p align="left" class="MsoNormal" style="text-align: left; margin: 0cm 0cm 0pt"><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">-</span><b><span lang="EN-US" style="font-family: consolas; color: #999999; font-size: 9pt">spec</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> uncompress(binary()) </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">-&gt;</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> binary().<br />
		</span><span lang="EN-US" style="font-family: consolas; color: #00a000; font-size: 9pt">uncompress</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">(</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Binary</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">) </span><b><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">when</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">byte_size</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">(</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Binary</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">) </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">&gt;=</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">8</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">-&gt;</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"><br />
		&nbsp;&nbsp;&nbsp; </span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Z</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">=</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> open(),<br />
		&nbsp;&nbsp;&nbsp; inflateInit(</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Z</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">),<br />
		&nbsp;&nbsp;&nbsp; Bs </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">=</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> inflate(</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Z</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">, </span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Binary</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">),<br />
		&nbsp;&nbsp;&nbsp; inflateEnd(</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Z</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">),<br />
		&nbsp;&nbsp;&nbsp; close(</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Z</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">),<br />
		&nbsp;&nbsp;&nbsp; </span><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">list_to_binary</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">(Bs);<br />
		</span><span lang="EN-US" style="font-family: consolas; color: #00a000; font-size: 9pt">uncompress</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">(</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Binary</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">) </span><b><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">when</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">is_binary</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">(</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Binary</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">) </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">-&gt;</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><b><span lang="EN-US" style="font-family: consolas; color: blue; font-size: 9pt">erlang</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">:error(data_error);<br />
		</span><span lang="EN-US" style="font-family: consolas; color: #00a000; font-size: 9pt">uncompress</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">(_) </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">-&gt;</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><b><span lang="EN-US" style="font-family: consolas; color: blue; font-size: 9pt">erlang</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">:error(badarg).<o:p></o:p></span></p>
</blockquote>
<p align="left" class="MsoNormal" style="text-align: left; margin: 0cm 0cm 0pt"><span lang="EN-US" style="font-size: 9pt"><o:p><font color="#000000" face="Calibri">&nbsp;</font></o:p></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt"><font color="#000000"><span lang="EN-US" style="font-size: 9pt"><font face="Calibri">open</font></span><span style="font-family: 宋体; font-size: 9pt; mso-ascii-font-family: calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: calibri; mso-hansi-theme-font: minor-latin">是返回一个</span><span lang="EN-US" style="font-size: 9pt"><font face="Calibri">port<o:p></o:p></font></span></font></p>
<blockquote>
	<p align="left" class="MsoNormal" style="text-align: left; margin: 0cm 0cm 0pt"><span lang="EN-US" style="font-family: consolas; color: #00a000; font-size: 9pt">open</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">() </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">-&gt;</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"><br />
		&nbsp;&nbsp;&nbsp; </span><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">open_port</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">({</span><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">spawn</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">, </span><span lang="EN-US" style="font-family: consolas; color: #bb4444; font-size: 9pt">&quot;zlib_drv&quot;</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">}, [binary]).</span><span lang="EN-US" style="font-size: 9pt"><font face="Calibri"><font color="#000000"><span style="mso-tab-count: 1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><o:p></o:p></font></font></span></p>
</blockquote>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt"><span lang="EN-US" style="font-size: 9pt"><font face="Calibri"><font color="#000000"><span style="mso-tab-count: 1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><o:p></o:p></font></font></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt"><font color="#000000"><span lang="EN-US" style="font-size: 9pt"><font face="Calibri">close</font></span><span style="font-family: 宋体; font-size: 9pt; mso-ascii-font-family: calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: calibri; mso-hansi-theme-font: minor-latin">则关闭一个</span><span lang="EN-US" style="font-size: 9pt"><font face="Calibri">port<o:p></o:p></font></span></font></p>
<blockquote>
	<p align="left" class="MsoNormal" style="text-align: left; margin: 0cm 0cm 0pt"><span lang="EN-US" style="font-family: consolas; color: #00a000; font-size: 9pt">close</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">(</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Z</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">) </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">-&gt;</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"><br />
		&nbsp;&nbsp;&nbsp; </span><b><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">try</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"><br />
		&nbsp;&nbsp;&nbsp; true </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">=</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">port_close</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">(</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Z</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">),<br />
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">receive</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><i><span lang="EN-US" style="font-family: consolas; color: #008800; font-size: 9pt">%In case the caller is the owner and traps exits</span></i><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"><br />
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&#39;EXIT&#39;,</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Z</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">,_} </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">-&gt;</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> ok<br />
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">after</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">0</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">-&gt;</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> ok<br />
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">end</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"><br />
		&nbsp;&nbsp;&nbsp; </span><b><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">catch</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> _:_ </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">-&gt;</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><b><span lang="EN-US" style="font-family: consolas; color: blue; font-size: 9pt">erlang</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">:error(badarg)<br />
		&nbsp;&nbsp;&nbsp; </span><b><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">end</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">.<br />
		<br />
		<br />
		</span><span lang="EN-US" style="font-family: consolas; color: #00a000; font-size: 9pt">inflate</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">(</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Z</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">, </span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Data</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">) </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">-&gt;</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"><br />
		&nbsp;&nbsp;&nbsp; </span><b><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">try</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">port_command</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">(</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Z</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">, </span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Data</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">) </span><b><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">of</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"><br />
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; true </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">-&gt;</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"><br />
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; call(</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Z</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">, </span><span lang="EN-US" style="font-family: consolas; color: #880000; font-size: 9pt">?INFLATE</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">, </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">&lt;&lt;</span><span lang="EN-US" style="font-family: consolas; color: #880000; font-size: 9pt">?Z_NO_FLUSH</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">:</span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">32&gt;&gt;</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">),<br />
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; collect(</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Z</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">)<br />
		&nbsp;&nbsp;&nbsp; </span><b><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">catch</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"><br />
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b><span lang="EN-US" style="font-family: consolas; color: blue; font-size: 9pt">error</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">:_</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Err</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">-&gt;</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"><br />
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; flush(</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Z</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">),<br />
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b><span lang="EN-US" style="font-family: consolas; color: blue; font-size: 9pt">erlang</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">:error(badarg)<br />
		&nbsp;&nbsp;&nbsp; </span><b><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">end</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">.<br />
		&nbsp;&nbsp;&nbsp; <br />
		<br />
		&nbsp;&nbsp;&nbsp; <br />
		</span><span lang="EN-US" style="font-family: consolas; color: #00a000; font-size: 9pt">call</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">(</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Z</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">, </span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Cmd</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">, </span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Arg</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">) </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">-&gt;</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"><br />
		&nbsp;&nbsp;&nbsp; </span><b><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">try</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">port_control</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">(</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Z</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">, </span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Cmd</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">, </span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Arg</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">) </span><b><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">of</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"><br />
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [</span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">0</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">|</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Res</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">] </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">-&gt;</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">list_to_atom</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">(</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Res</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">);<br />
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [</span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">1</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">|</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Res</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">] </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">-&gt;</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"><br />
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; flush(</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Z</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">),<br />
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b><span lang="EN-US" style="font-family: consolas; color: blue; font-size: 9pt">erlang</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">:error(</span><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">list_to_atom</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">(</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">Res</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">));<br />
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [</span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">2</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">,</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">A</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">,B,</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">C</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">,</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">D</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">] </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">-&gt;</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"><br />
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">A</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><b><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">bsl</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">24</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">)</span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">+</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">(B </span><b><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">bsl</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">16</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">)</span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">+</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">(</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">C</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><b><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">bsl</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">8</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">)</span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">+</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">D</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">;<br />
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [</span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">3</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">,</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">A</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">,B,</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">C</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">,</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">D</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">] </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">-&gt;</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"><br />
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b><span lang="EN-US" style="font-family: consolas; color: blue; font-size: 9pt">erlang</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">:error({need_dictionary,(</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">A</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><b><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">bsl</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">24</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">)</span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">+</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">(B </span><b><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">bsl</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">16</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">)</span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">+</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">(</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">C</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><b><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">bsl</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">8</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">)</span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">+</span><span lang="EN-US" style="font-family: consolas; color: darkgoldenrod; font-size: 9pt">D</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">})<br />
		&nbsp;&nbsp;&nbsp; </span><b><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">catch</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"><br />
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b><span lang="EN-US" style="font-family: consolas; color: blue; font-size: 9pt">error</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">:badarg </span><span lang="EN-US" style="font-family: consolas; color: #666666; font-size: 9pt">-&gt;</span><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"> </span><i><span lang="EN-US" style="font-family: consolas; color: #008800; font-size: 9pt">%% Rethrow loses port_control from stacktrace.</span></i><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt"><br />
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b><span lang="EN-US" style="font-family: consolas; color: blue; font-size: 9pt">erlang</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">:error(badarg)<br />
		&nbsp;&nbsp;&nbsp; </span><b><span lang="EN-US" style="font-family: consolas; color: #aa22ff; font-size: 9pt">end</span></b><span lang="EN-US" style="font-family: consolas; color: black; font-size: 9pt">.</span><span lang="EN-US" style="font-size: 9pt"><font face="Calibri"><font color="#000000"><span style="mso-tab-count: 1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><o:p></o:p></font></font></span></p>
</blockquote>
<p align="left" class="MsoNormal" style="text-align: left; margin: 0cm 0cm 0pt"><span lang="EN-US" style="font-size: 9pt"><o:p><font color="#000000" face="Calibri">&nbsp;</font></o:p></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt"><font color="#000000"><span lang="EN-US" style="font-size: 9pt"><font face="Calibri">erlang</font></span><span style="font-family: 宋体; font-size: 9pt; mso-ascii-font-family: calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: calibri; mso-hansi-theme-font: minor-latin">在遇到</span><span lang="EN-US" style="font-size: 9pt"><font face="Calibri">port</font></span><span style="font-family: 宋体; font-size: 9pt; mso-ascii-font-family: calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: calibri; mso-hansi-theme-font: minor-latin">返回错误时直接</span><span lang="EN-US" style="font-size: 9pt"><font face="Calibri">error</font></span><span style="font-family: 宋体; font-size: 9pt; mso-ascii-font-family: calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: calibri; mso-hansi-theme-font: minor-latin">了，典型的非防御性编程。</span><span style="font-size: 9pt"><font face="Calibri"> </font></span><span style="font-family: 宋体; font-size: 9pt; mso-ascii-font-family: calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: calibri; mso-hansi-theme-font: minor-latin">但是个人认为这个接口应该在抛出错误之前关闭掉打开的</span><span lang="EN-US" style="font-size: 9pt"><font face="Calibri">port</font></span><span style="font-family: 宋体; font-size: 9pt; mso-ascii-font-family: calibri; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: 宋体; mso-fareast-theme-font: minor-fareast; mso-hansi-font-family: calibri; mso-hansi-theme-font: minor-latin">。</span><span lang="EN-US" style="font-size: 9pt"><o:p></o:p></span></font></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt"><span lang="EN-US" style="font-size: 9pt"><o:p><font color="#000000" face="Calibri">&nbsp;</font></o:p></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt"><span lang="EN-US" style="font-size: 9pt"><span style="mso-tab-count: 1"><font color="#000000" face="Calibri">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font></span><o:p></o:p></span></p>
